{% extends "base.html" %}

{% from "macros.jinja" import window_vars with context %}


{% block page %}
  <div class="row q-col-gutter-md">
    <div class="col-12 col-md-8 col-lg-7 q-gutter-y-md">
      <q-card>
        <q-card-section>
          <q-btn unelevated color="deep-purple" @click="formDialog.show = true">New TPoS</q-btn>
        </q-card-section>
      </q-card>

      <q-card>
        <q-card-section>
          <div class="row items-center no-wrap q-mb-md">
            <div class="col">
              <h5 class="text-subtitle1 q-my-none">TPoS</h5>
            </div>
            <div class="col-auto">
              <q-btn flat color="grey" @click="exportCSV">Export to CSV</q-btn>
            </div>
          </div>
          <q-table dense flat
            :data="tposs"
            row-key="id"
            :columns="tpossTable.columns"
            :pagination.sync="tpossTable.pagination">
            {% raw %}
            <template v-slot:header="props">
              <q-tr :props="props">
                <q-th auto-width></q-th>
                <q-th
                  v-for="col in props.cols"
                  :key="col.name"
                  :props="props"
                >
                  {{ col.label }}
                </q-th>
                <q-th auto-width></q-th>
              </q-tr>
            </template>

            <template v-slot:body="props">
              <q-tr :props="props">
                <q-td auto-width>
                  <q-btn unelevated dense size="xs" icon="launch" :color="($q.dark.isActive) ? 'grey-7' : 'grey-5'" type="a" :href="props.row.tpos" target="_blank"></q-btn>
                </q-td>
                <q-td
                  v-for="col in props.cols"
                  :key="col.name"
                  :props="props"
                >
                  {{ col.value }}
                </q-td>
                <q-td auto-width>
                  <q-btn flat dense size="xs" @click="deleteTPoS(props.row.id)" icon="cancel" color="pink"></q-btn>
                </q-td>
              </q-tr>
            </template>
            {% endraw %}
          </q-table>
        </q-card-section>
      </q-card>
    </div>

    <div class="col-12 col-md-4 col-lg-5 q-gutter-y-md">
      <q-card>
        <q-card-section>
          <h6 class="text-subtitle1 q-my-none">LNbits TPoS extension</h6>
        </q-card-section>
        <q-card-section class="q-pa-none">
          <q-separator></q-separator>
          <q-list>
            <q-expansion-item
              group="extras"
              icon="info"
              label="Info">
              <q-card>
                <q-card-section>
                  <h5 class="text-subtitle1 q-mt-none q-mb-sm">Tiago's Point of Sale</h5>
                  <p>Is an instant and secure point of sale terminal. A merchant can use the PoS to accept payments to their LNbits wallet, without having to expose the wallet itself, which means it can even be shared with others.</p>
                  <p>For example, a merchant could setup multiple TPoSs for each one of their colleagues, and use TPoS to track which colleague has taken sales. The terminal is optimized for mobile use, and is easily shared as a QR code, via the "#" share function on the TPoS.</p>
                  <small>Created by <a href="https://github.com/talvasconcelos" target="_blank">Tiago Vasconcelos</a>.</small>
                </q-card-section>
              </q-card>
            </q-expansion-item>
          </q-list>
        </q-card-section>
      </q-card>
    </div>

    <q-dialog v-model="formDialog.show" position="top" @hide="closeFormDialog">
      <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
        <q-form class="q-gutter-md">
            <q-input filled dense
              v-model.trim="formDialog.data.name"
              label="Name"
              placeholder="Tiago's PoS"></q-input>
            <q-select filled dense
              emit-value v-model="formDialog.data.wallet"
              :options="g.user.walletOptions"
              label="Wallet *"></q-select>
            <q-select filled dense
              emit-value v-model="formDialog.data.currency"
              :options="currencyOptions"
              label="Currency *"></q-select>
            <div class="row q-mt-lg">
              <q-btn unelevated
                color="deep-purple"
                :disable="formDialog.data.currency == null || formDialog.data.name == null"
                @click="createTPoS">Create TPoS</q-btn>
              <q-btn v-close-popup flat color="grey" class="q-ml-auto">Cancel</q-btn>
            </div>
        </q-form>
      </q-card>
    </q-dialog>
  </div>
{% endblock %}

{% block scripts %}
  {{ window_vars(user) }}
  <script>
    var mapTPoS = function (obj) {
      obj.date = Quasar.utils.date.formatDate(new Date(obj.time * 1000), 'YYYY-MM-DD HH:mm');
      obj.fsat = new Intl.NumberFormat(LOCALE).format(obj.amount);
      obj.tpos = ['/tpos/', obj.id].join('');
      return obj;
    }

    new Vue({
      el: '#vue',
      mixins: [windowMixin],
      data: function () {
        return {
          tposs: [],
          currencyOptions: [
            {value: 'USD', label: 'USD - United States Dollars'},
            {value: 'EUR', label: 'EUR - Euro'},
            {value: 'GBP', label: 'GBP - United Kingdom Pounds'},
            {value: 'DZD', label: 'DZD - Algeria Dinars'},
            {value: 'ARP', label: 'ARP - Argentina Pesos'},
            {value: 'AUD', label: 'AUD - Australia Dollars'},
            {value: 'ATS', label: 'ATS - Austria Schillings'},
            {value: 'BSD', label: 'BSD - Bahamas Dollars'},
            {value: 'BBD', label: 'BBD - Barbados Dollars'},
            {value: 'BEF', label: 'BEF - Belgium Francs'},
            {value: 'BMD', label: 'BMD - Bermuda Dollars'},
            {value: 'BRL', label: 'BRL - Brazil Real'},
            {value: 'BGL', label: 'BGL - Bulgaria Lev'},
            {value: 'CAD', label: 'CAD - Canada Dollars'},
            {value: 'CLP', label: 'CLP - Chile Pesos'},
            {value: 'CNY', label: 'CNY - China Yuan Renmimbi'},
            {value: 'CYP', label: 'CYP - Cyprus Pounds'},
            {value: 'CSK', label: 'CSK - Czech Republic Koruna'},
            {value: 'DKK', label: 'DKK - Denmark Kroner'},
            {value: 'NLG', label: 'NLG - Dutch Guilders'},
            {value: 'XCD', label: 'XCD - Eastern Caribbean Dollars'},
            {value: 'EGP', label: 'EGP - Egypt Pounds'},
            {value: 'FJD', label: 'FJD - Fiji Dollars'},
            {value: 'FIM', label: 'FIM - Finland Markka'},
            {value: 'FRF', label: 'FRF - France Francs'},
            {value: 'DEM', label: 'DEM - Germany Deutsche Marks'},
            {value: 'XAU', label: 'XAU - Gold Ounces'},
            {value: 'GRD', label: 'GRD - Greece Drachmas'},
            {value: 'HKD', label: 'HKD - Hong Kong Dollars'},
            {value: 'HUF', label: 'HUF - Hungary Forint'},
            {value: 'ISK', label: 'ISK - Iceland Krona'},
            {value: 'INR', label: 'INR - India Rupees'},
            {value: 'IDR', label: 'IDR - Indonesia Rupiah'},
            {value: 'IEP', label: 'IEP - Ireland Punt'},
            {value: 'ILS', label: 'ILS - Israel New Shekels'},
            {value: 'ITL', label: 'ITL - Italy Lira'},
            {value: 'JMD', label: 'JMD - Jamaica Dollars'},
            {value: 'JPY', label: 'JPY - Japan Yen'},
            {value: 'JOD', label: 'JOD - Jordan Dinar'},
            {value: 'KRW', label: 'KRW - Korea (South) Won'},
            {value: 'LBP', label: 'LBP - Lebanon Pounds'},
            {value: 'LUF', label: 'LUF - Luxembourg Francs'},
            {value: 'MYR', label: 'MYR - Malaysia Ringgit'},
            {value: 'MXP', label: 'MXP - Mexico Pesos'},
            {value: 'NLG', label: 'NLG - Netherlands Guilders'},
            {value: 'NZD', label: 'NZD - New Zealand Dollars'},
            {value: 'NOK', label: 'NOK - Norway Kroner'},
            {value: 'PKR', label: 'PKR - Pakistan Rupees'},
            {value: 'XPD', label: 'XPD - Palladium Ounces'},
            {value: 'PHP', label: 'PHP - Philippines Pesos'},
            {value: 'XPT', label: 'XPT - Platinum Ounces'},
            {value: 'PLZ', label: 'PLZ - Poland Zloty'},
            {value: 'PTE', label: 'PTE - Portugal Escudo'},
            {value: 'ROL', label: 'ROL - Romania Leu'},
            {value: 'RUR', label: 'RUR - Russia Rubles'},
            {value: 'SAR', label: 'SAR - Saudi Arabia Riyal'},
            {value: 'XAG', label: 'XAG - Silver Ounces'},
            {value: 'SGD', label: 'SGD - Singapore Dollars'},
            {value: 'SKK', label: 'SKK - Slovakia Koruna'},
            {value: 'ZAR', label: 'ZAR - South Africa Rand'},
            {value: 'KRW', label: 'KRW - South Korea Won'},
            {value: 'ESP', label: 'ESP - Spain Pesetas'},
            {value: 'XDR', label: 'XDR - Special Drawing Right (IMF)'},
            {value: 'SDD', label: 'SDD - Sudan Dinar'},
            {value: 'SEK', label: 'SEK - Sweden Krona'},
            {value: 'CHF', label: 'CHF - Switzerland Francs'},
            {value: 'TWD', label: 'TWD - Taiwan Dollars'},
            {value: 'THB', label: 'THB - Thailand Baht'},
            {value: 'TTD', label: 'TTD - Trinidad and Tobago Dollars'},
            {value: 'TRL', label: 'TRL - Turkey Lira'},
            {value: 'VEB', label: 'VEB - Venezuela Bolivar'},
            {value: 'ZMK', label: 'ZMK - Zambia Kwacha'},
            {value: 'EUR', label: 'EUR - Euro'},
            {value: 'XCD', label: 'XCD - Eastern Caribbean Dollars'},
            {value: 'XDR', label: 'XDR - Special Drawing Right (IMF)'},
            {value: 'XAG', label: 'XAG - Silver Ounces'},
            {value: 'XAU', label: 'XAU - Gold Ounces'},
            {value: 'XPD', label: 'XPD - Palladium Ounces'},
            {value: 'XPT', label: 'XPT - Platinum Ounces'}
          ],
          tpossTable: {
            columns: [
              {name: 'id', align: 'left', label: 'ID', field: 'id'},
              {name: 'name', align: 'left', label: 'Name', field: 'name'},
              {name: 'currency', align: 'left', label: 'Currency', field: 'currency'}
            ],
            pagination: {
              rowsPerPage: 10
            }
          },
          formDialog: {
            show: false,
            data: {}
          }
        };
      },
      methods: {
        closeFormDialog: function () {
          this.formDialog.data = {};
        },
        getTPoSs: function () {
          var self = this;

          LNbits.api.request(
            'GET',
            '/tpos/api/v1/tposs?all_wallets',
            this.g.user.wallets[0].inkey
          ).then(function (response) {
            self.tposs = response.data.map(function (obj) {
              return mapTPoS(obj);
            });
          });
        },
        createTPoS: function () {
          var data = {
            name: this.formDialog.data.name,
            currency: this.formDialog.data.currency
          };
          var self = this;

          LNbits.api.request(
            'POST',
            '/tpos/api/v1/tposs',
            _.findWhere(this.g.user.wallets, {id: this.formDialog.data.wallet}).inkey,
            data
          ).then(function (response) {
            self.tposs.push(mapTPoS(response.data));
            self.formDialog.show = false;
          }).catch(function (error) {
            LNbits.utils.notifyApiError(error);
          });
        },
        deleteTPoS: function (tposId) {
          var self = this;
          var tpos = _.findWhere(this.tposs, {id: tposId});

          this.$q.dialog({
            message: 'Are you sure you want to delete this TPoS?',
            ok: {
              flat: true,
              color: 'orange'
            },
            cancel: {
              flat: true,
              color: 'grey'
            }
          }).onOk(function () {
            LNbits.api.request(
              'DELETE',
              '/tpos/api/v1/tposs/' + tposId,
              _.findWhere(self.g.user.wallets, {id: tpos.wallet}).inkey
            ).then(function (response) {
              self.tposs = _.reject(self.tposs, function (obj) { return obj.id == tposId; });
            }).catch(function (error) {
              LNbits.utils.notifyApiError(error);
            });
          });
        },
        exportCSV: function () {
          LNbits.utils.exportCSV(this.tpossTable.columns, this.tposs);
        }
      },
      created: function () {
        if (this.g.user.wallets.length) {
          this.getTPoSs();
        }
      }
    });
  </script>
{% endblock %}
